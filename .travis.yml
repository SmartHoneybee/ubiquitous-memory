language: c
dist: trusty
addons:
  apt:
    sources:
      - sourceline: 'deb https://dl.yarnpkg.com/debian/ stable main'
        key_url: 'https://dl.yarnpkg.com/debian/pubkey.gpg'
      - sourceline: 'deb https://deb.nodesource.com/node_8.x trusty main'
        key_url: 'https://deb.nodesource.com/gpgkey/nodesource.gpg.key'
      - sourceline: 'ppa:gophers/archive'
    packages:
      - nodejs
      - yarn
      - golang-1.9-go
      - build-essential
env:
  global:
    - GOPATH=$HOME/go
    - PATH=/usr/lib/go-1.9/bin:$PATH:$GOPATH/bin
  matrix:
    - V=4.3.0
    - V=4.3.1
before_install:
  - node --version
  - yarn version
  - go version
  - mkdir ~/go
  - ulimit -n 8096
  - mkdir -p ~/go/src/github.com/mattermost
  - cd ~/go/src/github.com/mattermost
  - wget "https://github.com/mattermost/mattermost-server/archive/v${V}.tar.gz"
  - tar xf "v${V}.tar.gz"
  - mv "mattermost-server-${V}" mattermost-server
  - rm "v${V}.tar.gz"
  - wget "https://github.com/mattermost/mattermost-webapp/archive/v${V}.tar.gz"
  - tar xf "v${V}.tar.gz"
  - mv "mattermost-webapp-${V}" mattermost-webapp
  - rm "v${V}.tar.gz"
  - cd ~/go/src/github.com/mattermost/mattermost-server
  - patch -p1 < $TRAVIS_BUILD_DIR/make.patch
script:
  - make build-linux package
